<html>
<body>
<canvas id='myCanvas' width='500' height='300' style='border: 1px solid #000000;'>
</canvas>
<br/><br/>
<div>Number of cells rendered: <span id='totalCellCount'>1</span></div>
<div>Number of active cells: <span id='cellCount'>1</span></div>
<div>Reproduction Rate: <span id='reproductionRate'></span></div>
<div>Mutation Rate: <span id='mutationRate'></span></div>
<div>Lifespan: <span id='lifespan'></span></div>
</body>
<script type='text/javascript'>
  var canvas = document.getElementById('myCanvas');
  var context = canvas.getContext('2d');

  window.stop = false;

  var WIDTH_MAX = 500;
  var HEIGHT_MAX = 300;
  var CHANCE_OF_MUTATION = 0.1;
  var CHANCE_OF_BABY = 1.5;
  var LIFE = 5;
  var TIMEOUT = 50;

  var totalCellsCreated = 0;

  var globalPixel = context.createImageData(1, 1);
  var data = globalPixel.data;
  data[3] = 256;

  function drawDeadCell(cell) { 
    data[0] = cell.red;
    data[1] = cell.green;
    data[2] = cell.blue;
    data[3] = 256;

    context.putImageData(globalPixel, cell.x, cell.y);
  }

  function drawLivingCell(cell) {
    if (cell.life % 2 == 0) {
      data[0] = 0;
      data[1] = 0;
      data[2] = 0;
      data[3] = 256;
    }
    else {
      data[0] = 256;
      data[1] = 256;
      data[2] = 256;
      data[3] = 0;
    }

    context.putImageData(globalPixel, cell.x, cell.y);
  }

  var cells = [{
      red: 128,
      green: 128,
      blue: 128,
      x: 250,
      y: 150,
      life: LIFE 
  }];
  var presenceTable = [];
  
  function addToPresenceTable(cell) {
    totalCellsCreated++;
    var row = presenceTable[cell.x];
    if (row === undefined) {
      presenceTable[cell.x] = [];
    } 
    presenceTable[cell.x][cell.y] = cell;
  }

  function removeFromPresenceTable(cell) {
    presenceTable[cell.x][cell.y] = undefined;
  }

  function isNothingInPresenceTable(x, y) {
    return presenceTable[x] === undefined || presenceTable[x][y] === undefined;
  }

  addToPresenceTable(cells[0]);

  function cloneColorWithPossibilityOfMutation(colorValue) { 
    if (CHANCE_OF_MUTATION > Math.random()) {
      return Math.floor(Math.random() * 1000000 % 128);
    }
    else {
      return colorValue;
    }
  }

  function havingBabyAt(x, y) {
    return x > 0 && x < WIDTH_MAX && 
           y > 0 && y < HEIGHT_MAX && 
           isNothingInPresenceTable(x, y) &&
           (cells.length == 0 || CHANCE_OF_BABY > Math.random());
  }

  function generateNewLifeSpan(life) {
    return LIFE;
  }

  function makeBabyAt(cell, x, y) {
    var baby = { 
      id: totalCellsCreated,
      red: cloneColorWithPossibilityOfMutation(cell.red),
      green: cloneColorWithPossibilityOfMutation(cell.green),
      blue: cloneColorWithPossibilityOfMutation(cell.blue),
      x: x,
      y: y,
      life: generateNewLifeSpan(LIFE)
    };

    addToPresenceTable(baby);
    return baby;
  }

  function makeBabies(cell) {
    var babies = [];
    // East
    if (havingBabyAt(cell.x + 1, cell.y)) {
      babies.push(makeBabyAt(cell, cell.x + 1, cell.y));
    }
    // West
    if (havingBabyAt(cell.x - 1, cell.y)) {
      babies.push(makeBabyAt(cell, cell.x - 1, cell.y));
    }
    // South
    if (havingBabyAt(cell.x, cell.y + 1)) {
      babies.push(makeBabyAt(cell, cell.x, cell.y + 1));
    }
    // North
    if (havingBabyAt(cell.x, cell.y - 1)) {
      babies.push(makeBabyAt(cell, cell.x, cell.y - 1));
    }

    return babies;
  }

  function killCell(cell) {
    drawDeadCell(cell);
  }

  function blinkCell(cell) {
    drawLivingCell(cell);
    cell.life--;
  }

  function updateStaticStats() {
    document.getElementById('reproductionRate').innerHTML = CHANCE_OF_BABY;
    document.getElementById('mutationRate').innerHTML = CHANCE_OF_MUTATION;
    document.getElementById('lifespan').innerHTML = LIFE;
  }

  function updateDynamicStats() {
    var cellCount = document.getElementById('cellCount');
    cellCount.innerHTML = cells.length > 0 ? cells.length : '0 - Permadeath';
    var totalCellsCount = document.getElementById('totalCellCount');
    totalCellsCount.innerHTML = totalCellsCreated;
  }

  window.stop = function() {
    window.stop = true;
  };

  window.tick = function() {
    window.stop = false;
    oneTick(false);
  };

  window.pixelAt = function(x, y) {
    var imgd = context.getImageData(x, y, 1, 1);
    return imgd.data;
  };

  function oneTick(run) {
    if (run === undefined) {
      run = true;
    }

    var newCellsForTheTick = [];
    var deadCellsForTheTick = 0;

    for (var i in cells) {
      if (window.stop == true) {
        console.log('Found hard stop');
        window.cells = cells;
        window.presenceTable = presenceTable;
        return false;
      }
      var cell = cells[i];

      if (cell.life > 0) {
        blinkCell(cell);
      }
      else {
        killCell(cell);
        deadCellsForTheTick++;
        var newBabies = makeBabies(cell);
        newCellsForTheTick.push.apply(newCellsForTheTick, newBabies);
      }
    }

    cells.push.apply(cells, newCellsForTheTick);
    for (var i = 0; i < deadCellsForTheTick; i++) {
      cells.shift();
    }

    if (run && cells.length > 0) {
      window.setTimeout(oneTick, TIMEOUT);
    }
    else if (run) {
      console.log('Permadeath');
    }
    updateDynamicStats();
  }

  updateStaticStats();
  oneTick();
</script>
</html>
